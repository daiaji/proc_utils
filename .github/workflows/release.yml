# 工作流名称
name: Create GitHub Release

# 工作流触发条件
on:
  # 1. 自动触发：当推送 'v*' 格式的标签时
  push:
    tags:
      - "v*"
  
  # 2. 手动触发：允许在 Actions 页面手动运行此工作流
  workflow_dispatch:
    inputs:
      tag_name:
        description: '要创建的标签和版本号 (例如: v1.0.1)'
        required: true
        type: string
      release_name:
        description: '发布的标题 (可选, 默认为 "Release [tag_name]")'
        required: false
      body:
        description: '发布说明 (可选, 支持 Markdown)'
        required: false
      draft:
        description: '是否创建为草稿?'
        required: true
        type: boolean
        default: false
      prerelease:
        description: '是否标记为预发布版本?'
        required: true
        type: boolean
        default: false

# 定义任务
jobs:
  # 发布任务
  release:
    # 指定运行环境
    runs-on: windows-latest
    
    # 为此任务授予创建 Release 所需的写入权限
    permissions:
      contents: write

    # 任务步骤
    steps:
      # 步骤1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2: 设置 MSVC 开发环境
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1
      
      # 步骤3: 定义发布变量 (提前定义，方便后续步骤使用)
      - name: Set Release Variables
        id: vars
        run: |
          if ("${{ github.event_name }}" -eq "push") {
            echo "tag_name=${{ github.ref_name }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "tag_name=${{ inputs.tag_name }}" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      # --- 动态库构建阶段 ---
      - name: Configure CMake (Shared Library)
        run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DBUILD_SHARED_LIBS=ON

      - name: Build Project (Shared Library)
        run: cmake --build build --config Release

      - name: Prepare Release Package (Shared)
        run: |
          mkdir release_package_shared
          copy "build\Release\proc_utils.dll" "release_package_shared\"
          copy "build\Release\proc_utils.lib" "release_package_shared\"
          copy "include\proc_utils.h" "release_package_shared\"

      - name: Create Zip Archive (Shared)
        run: Compress-Archive -Path "release_package_shared\*" -DestinationPath "proc_utils-shared-${{ steps.vars.outputs.tag_name }}.zip"

      # --- 静态库构建阶段 ---
      - name: Clean Build Directory for Static Build
        # 这是至关重要的一步，确保两次构建之间是完全干净的
        run: Remove-Item -Recurse -Force build
        shell: pwsh
      
      - name: Configure CMake (Static Library)
        run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DBUILD_SHARED_LIBS=OFF

      - name: Build Project (Static Library)
        run: cmake --build build --config Release

      - name: Prepare Release Package (Static)
        run: |
          mkdir release_package_static
          copy "build\Release\proc_utils.lib" "release_package_static\"
          copy "include\proc_utils.h" "release_package_static\"

      - name: Create Zip Archive (Static)
        run: Compress-Archive -Path "release_package_static\*" -DestinationPath "proc_utils-static-${{ steps.vars.outputs.tag_name }}.zip"
        
      # --- 发布阶段 ---
      - name: Create Release and Upload Artifacts
        uses: softprops/action-gh-release@v1
        with:
          # 核心修改：同时上传两个 zip 包
          files: |
            proc_utils-shared-${{ steps.vars.outputs.tag_name }}.zip
            proc_utils-static-${{ steps.vars.outputs.tag_name }}.zip
          tag_name: ${{ steps.vars.outputs.tag_name }}
          name: "${{ inputs.release_name || format('Release {0}', steps.vars.outputs.tag_name) }}"
          body: ${{ inputs.body }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}