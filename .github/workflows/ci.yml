name: Proc-Utils CI

on:
  push:
    branches: ["main", "master", "FFI"]
  pull_request:
    branches: ["main", "master", "FFI"]
  workflow_dispatch:

jobs:
  test-windows:
    name: Test on Windows (LuaJIT)
    runs-on: windows-latest
    
    timeout-minutes: 5
    
    env:
      LUAJIT_INSTALL_DIR: ${{ github.workspace }}\.luajit_bin
      LUAJIT_SUBMODULE_PATH: vendor/luajit2

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          # [CRITICAL] Recursively checkout submodules to get both vendor/luajit2 and vendor/luaunit
          submodules: 'recursive'

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Get LuaJIT submodule commit hash
        id: luajit-hash
        shell: pwsh
        run: |
          $submodule_hash = (git submodule status ${{ env.LUAJIT_SUBMODULE_PATH }}).Trim().Split(' ')[0]
          echo "hash=$submodule_hash" >> $env:GITHUB_OUTPUT

      - name: Cache MSVC-built LuaJIT
        id: cache-luajit
        uses: actions/cache@v4
        with:
          path: ${{ env.LUAJIT_INSTALL_DIR }}
          # Increment key version if build logic changes
          key: luajit-openresty-v2.5-${{ runner.os }}-${{ steps.luajit-hash.outputs.hash }}

      - name: Build and Verify LuaJIT (if not cached)
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        working-directory: ${{ env.LUAJIT_SUBMODULE_PATH }}/src
        shell: pwsh
        run: |
          # 1. Build LuaJIT
          Write-Host "Building LuaJIT..."
          $env:CL = "/DLUAJIT_ENABLE_LUA52COMPAT"
          .\msvcbuild.bat
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::LuaJIT build failed!"
            exit 1
          }

          # 2. Install Layout
          $install_dir = "${{ env.LUAJIT_INSTALL_DIR }}"
          Write-Host "Preparing installation directory: $install_dir"
          New-Item -ItemType Directory -Path $install_dir -Force
          
          $lua_lib_dir = Join-Path $install_dir "lua"
          New-Item -ItemType Directory -Path $lua_lib_dir -Force

          Write-Host "Copying binaries..."
          Copy-Item -Path "luajit.exe", "lua51.dll", "lua51.lib" -Destination $install_dir
          Copy-Item -Path "luajit.exe" -Destination "$install_dir\lua.exe"
          
          # 3. Install JIT Libs
          $jit_source_path = Join-Path $PWD "jit"
          if (Test-Path $jit_source_path) {
            Copy-Item -Path $jit_source_path -Destination $lua_lib_dir -Recurse
          } else {
            Write-Host "::error::jit directory not found in source after build!"
            exit 1
          }

      - name: Add LuaJIT to PATH
        shell: pwsh
        run: |
          echo "${{ env.LUAJIT_INSTALL_DIR }}" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      - name: Debug Environment
        shell: pwsh
        run: |
          Get-Command luajit.exe | Format-List
          
          # Verify LuaUnit submodule existence
          if (Test-Path "vendor/luaunit/luaunit.lua") {
             Write-Host "LuaUnit found."
          } else {
             Write-Host "::error::LuaUnit submodule missing!"
             exit 1
          }

      - name: Run Tests with Profiler
        shell: pwsh
        run: |
          # Directly invoke luajit. package.path in spec file handles submodule location.
          luajit.exe "-jp=fl,profile.log" tests/proc_utils_spec.lua

      - name: Display Profile Log
        if: always()
        shell: pwsh
        run: |
          if (Test-Path profile.log) {
            Write-Host "--- Profiler Output (Head 50) ---"
            Get-Content profile.log -TotalCount 50
          }