# GitHub Actions 工作流名称
name: C++ CI (Build, Format, Analyze & Test) # <-- 名称更新

# 工作流触发条件
on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

# 定义一系列任务（jobs）
jobs:
  build-analyze-and-test: # <-- Job 名称更新
    # 指定运行此任务的操作系统环境
    runs-on: windows-latest

    # 任务执行的步骤
    steps:
      # 步骤1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2: 检查代码格式
      - name: Check Code Formatting
        run: |
          clang-format -style=file --dry-run -Werror $(git ls-files 'src/*.cpp' 'src/*.h' 'include/*.h')
        shell: bash

      # 步骤3: 设置 MSVC 开发环境
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      # 步骤4: 配置 CMake
      - name: Configure CMake
        run: cmake -B build -G "Visual Studio 17 2022" -A x64

      # 步骤5: 编译项目并执行静态分析
      - name: Build Project & Run Static Analysis
        run: cmake --build build --config Release -- /p:RunCodeAnalysis=true /p:CodeAnalysisTreatWarningsAsErrors=true
        
      # --- 新增步骤：运行测试 ---
      - name: Run Python Test Suite
        # Runner 默认已安装 Python
        # 我们将编译输出目录 ('build/Release')作为参数传递给测试脚本
        run: python tests/run_tests.py build/Release
        shell: bash