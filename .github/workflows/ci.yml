name: Proc-Utils CI

on:
  push:
    branches: ["main", "master", "FFI"]
  pull_request:
    branches: ["main", "master", "FFI"]
  workflow_dispatch:

jobs:
  test-windows:
    name: Test on Windows (LuaJIT)
    runs-on: windows-latest
    timeout-minutes: 5
    
    env:
      LUAJIT_BIN_DIR: ${{ github.workspace }}\.luajit_bin
      LUAJIT_SRC_DIR: vendor/luajit/src

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Cache LuaJIT Build
        id: cache-luajit
        uses: actions/cache@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ runner.os }}-luajit-${{ hashFiles('vendor/luajit/.git') }}
          restore-keys: |
            ${{ runner.os }}-luajit-

      - name: Build LuaJIT
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd %LUAJIT_SRC_DIR%
          call msvcbuild.bat gc64
          if %errorlevel% neq 0 exit /b %errorlevel%
          mkdir "%LUAJIT_BIN_DIR%"
          copy luajit.exe "%LUAJIT_BIN_DIR%\"
          copy lua51.dll "%LUAJIT_BIN_DIR%\"
          mkdir "%LUAJIT_BIN_DIR%\jit"
          xcopy /s /y "jit\*.*" "%LUAJIT_BIN_DIR%\jit\"

      - name: Add LuaJIT to PATH
        shell: pwsh
        run: echo "${{ env.LUAJIT_BIN_DIR }}" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # ========================================================================
      # 搭建测试环境
      # ========================================================================
      - name: Setup Test Environment
        shell: pwsh
        run: |
          $envDir = "$PWD\.test_env"
          if (Test-Path $envDir) { Remove-Item $envDir -Recurse -Force }
          New-Item -ItemType Directory -Path $envDir -Force | Out-Null

          Write-Host "=== Setting up Environment ==="

          # 1. 准备 ffi 库 
          # 目标路径: .test_env/ffi
          $ffiSource = "vendor/lua-ffi-bindings"
          $ffiDest = Join-Path $envDir "ffi"
          
          if (Test-Path $ffiSource) {
            Write-Host "Copying lua-ffi-bindings -> .test_env/ffi ..."
            robocopy $ffiSource $ffiDest /E /XD vendor .git /NFL /NDL /NJH /NJS
            if ($LASTEXITCODE -ge 8) { throw "Robocopy ffi failed" }
            $LASTEXITCODE = 0
          } else {
             Write-Error "vendor/lua-ffi-bindings not found!"
             exit 1
          }

          # 2. 准备 ext 库 (关键步骤！)
          # 目标路径: .test_env/ext 
          # 这样 require('ext.assert') 才能找到 .test_env/ext/assert.lua
          $extSource = "vendor/lua-ext"
          $extDest = Join-Path $envDir "ext"
          
          if (Test-Path $extSource) {
            Write-Host "Copying lua-ext -> .test_env/ext ..."
            # Robocopy 会自动创建目标目录 $extDest
            robocopy $extSource $extDest /E /XD vendor .git /NFL /NDL /NJH /NJS
            if ($LASTEXITCODE -ge 8) { throw "Robocopy ext failed" }
            $LASTEXITCODE = 0
          } else {
             Write-Error "vendor/lua-ext not found! Please add submodule: git submodule add https://github.com/daiaji/lua-ext.git vendor/lua-ext"
             exit 1
          }

          # 3. 下载 LuaUnit
          $luUrl = "https://raw.githubusercontent.com/bluebird75/luaunit/master/luaunit.lua"
          Write-Host "Downloading luaunit.lua..."
          Invoke-WebRequest -Uri $luUrl -OutFile (Join-Path $envDir "luaunit.lua")

      # ========================================================================
      # 运行测试
      # ========================================================================
      - name: Run Tests
        shell: pwsh
        run: |
          $root = ($PWD.Path -replace "\\", "/")
          
          # 设置 LUA_PATH 原理：
          # 1. $root/.test_env/?.lua 
          #    - 匹配 require('ext.assert') -> .test_env/ext/assert.lua (成功)
          #    - 匹配 require('luaunit')    -> .test_env/luaunit.lua (成功)
          #
          # 2. $root/.test_env/?/init.lua
          #    - 匹配 require('ffi')        -> .test_env/ffi/init.lua (如果有的话，或者配合 req.lua 使用)
          #
          # 3. $root/?.lua
          #    - 匹配 require('proc_utils_ffi') -> ./proc_utils_ffi.lua
          
          $env:LUA_PATH = "$root/.test_env/?.lua;$root/.test_env/?/init.lua;$root/?.lua;;"
          
          Write-Host "LUA_PATH: $env:LUA_PATH"
          
          # 运行测试
          luajit tests/proc_utils_spec.lua -v